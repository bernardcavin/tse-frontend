import{d as L,j as e,S as p,h as E,ah as z,Q as w,T as h,a8 as I,at as B,k as M,r as k,m as N,W as O,X as P,e as U,au as F,av as G,i as $,p as R}from"./index--ClWZahu.js";import{P as K}from"./page-CknD4dKm.js";import{P as V}from"./page-header-BWjuV_E8.js";import{b as W,u as Q,c as X,a as q,d as J,e as Y,o as Z}from"./hazard-observations-modals-DFQca6Bj.js";import{I as ee}from"./IconFileAlert-IqUr3CM8.js";import{c as te}from"./createReactComponent-BM7tdotx.js";import{I as ae,P as se,L as oe}from"./IconClock-DZ2a-qfR.js";import{I as re}from"./IconCheck-DpEWvlmQ.js";import{G as _}from"./form-section-C5VgLGpa.js";import{T as A}from"./Title-Ci985OzB.js";import{D as d,A as ne}from"./index-DqV8S-Pt.js";import{a as ie}from"./IconX-DuMbzP0j.js";import"./Anchor-DIBe1ZWb.js";import"./date-CCyo-1EX.js";import"./DatePickerInput-BeLOAKO0.js";import"./file-upload-DQ7A5yty.js";import"./form-CN9S1QwI.js";import"./facilities-BJtlO5v9.js";import"./facility-CsGiLvNK.js";import"./use-form-L8LbUW_M.js";import"./IconPlus-BmH8SaqF.js";import"./Select-UMZ64bLE.js";import"./index-Bn0zxFJ3.js";/**
 * @license @tabler/icons-react v3.14.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var le=te("outline","alert-triangle","IconAlertTriangle",[["path",{d:"M12 9v4",key:"svg-0"}],["path",{d:"M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z",key:"svg-1"}],["path",{d:"M12 16h.01",key:"svg-2"}]]);function de(){var c,i,l,y;const{user:t}=L(),{data:o,isLoading:u}=W();if((t==null?void 0:t.role)!=="MANAGER"&&(t==null?void 0:t.department)!=="HSE"||u||!o)return null;const m=Object.entries(o.status_breakdown||{}).map(([s,n])=>({name:s.replace("_"," ").toUpperCase(),value:n,color:s==="open"?"red.6":s==="in_progress"?"yellow.6":s==="resolved"?"green.6":"gray.6"})).filter(s=>s.value>0),b=Object.entries(o.hazard_types_distribution||{}).map(([s,n])=>({hazard:s.replace("_"," "),count:n})).sort((s,n)=>n.count-s.count).slice(0,6),g=(o.monthly_trend||[]).map(s=>({month:s.month||"N/A",observations:s.count||0})),v=[{title:"Total Observations",value:o.total_observations||0,icon:ee,color:"blue"},{title:"Open",value:((c=o.status_breakdown)==null?void 0:c.open)||0,icon:le,color:"red"},{title:"In Progress",value:((i=o.status_breakdown)==null?void 0:i.in_progress)||0,icon:ae,color:"yellow"},{title:"Resolved",value:((l=o.status_breakdown)==null?void 0:l.resolved)||0,icon:re,color:"green"}],j=o.total_observations||0,x=((y=o.status_breakdown)==null?void 0:y.resolved)||0,r=j>0?(x/j*100).toFixed(1):"0.0";return e.jsxs(p,{gap:"lg",mb:"lg",children:[e.jsx(E,{cols:{base:1,sm:2,md:4},children:v.map(s=>{const n=s.icon;return e.jsx(z,{padding:"md",radius:"md",withBorder:!0,children:e.jsxs(w,{justify:"space-between",children:[e.jsxs(p,{gap:0,children:[e.jsx(h,{size:"xs",c:"dimmed",fw:500,children:s.title}),e.jsx(h,{size:"xl",fw:700,children:s.value})]}),e.jsx(n,{size:32,stroke:1.5,color:`var(--mantine-color-${s.color}-6)`})]})},s.title)})}),e.jsxs(_,{children:[e.jsx(_.Col,{span:{base:12,md:6},children:e.jsx(z,{padding:"lg",radius:"md",withBorder:!0,h:"100%",children:e.jsxs(p,{gap:"md",children:[e.jsxs(w,{justify:"space-between",children:[e.jsx(A,{order:4,children:"Status Distribution"}),e.jsxs(h,{size:"sm",c:"dimmed",children:["Resolution Rate: ",r,"%"]})]}),e.jsx(I,{children:m.length>0?e.jsx(se,{data:m,withLabelsLine:!0,labelsPosition:"outside",labelsType:"value",withLabels:!0,withTooltip:!0,tooltipDataSource:"segment"}):e.jsx(h,{size:"sm",c:"dimmed",ta:"center",py:"xl",children:"No data available"})})]})})}),e.jsx(_.Col,{span:{base:12,md:6},children:e.jsx(z,{padding:"lg",radius:"md",withBorder:!0,h:"100%",children:e.jsxs(p,{gap:"md",children:[e.jsx(A,{order:4,children:"Top Hazard Types"}),b.length>0?e.jsx(B,{h:280,data:b,dataKey:"hazard",series:[{name:"count",color:"blue.6",label:"Count"}],tickLine:"y",gridAxis:"y",withTooltip:!0,withLegend:!0,tooltipAnimationDuration:200,xAxisProps:{angle:-45,textAnchor:"end",height:100}}):e.jsx(h,{size:"sm",c:"dimmed",ta:"center",py:"xl",children:"No data available"})]})})}),e.jsx(_.Col,{span:{base:12,md:8},children:e.jsx(z,{padding:"lg",radius:"md",withBorder:!0,children:e.jsxs(p,{gap:"md",children:[e.jsx(A,{order:4,children:"Observations Trend (Last 6 Months)"}),g.length>0?e.jsx(oe,{h:300,data:g,dataKey:"month",series:[{name:"observations",color:"blue.6",label:"Observations"}],curveType:"linear",withTooltip:!0,withLegend:!0,tooltipAnimationDuration:200,connectNulls:!0,withDots:!0,gridAxis:"xy"}):e.jsx(h,{size:"sm",c:"dimmed",ta:"center",py:"xl",children:"No data available"})]})})}),e.jsx(_.Col,{span:{base:12,md:4},children:e.jsx(z,{padding:"lg",radius:"md",withBorder:!0,h:"100%",children:e.jsxs(p,{gap:"md",children:[e.jsx(A,{order:4,children:"Top Facilities"}),e.jsxs(p,{gap:"sm",children:[(o.top_facilities||[]).slice(0,5).map((s,n)=>e.jsxs(w,{justify:"space-between",p:"xs",style:{borderLeft:"3px solid var(--mantine-color-red-6)",backgroundColor:"var(--mantine-color-gray-0)"},children:[e.jsx(h,{size:"sm",fw:500,style:{flex:1},truncate:!0,children:s.facility_name||s.facility_id}),e.jsx(h,{size:"sm",fw:700,c:"red",children:s.count})]},n)),(!o.top_facilities||o.top_facilities.length===0)&&e.jsx(h,{size:"sm",c:"dimmed",ta:"center",children:"No data available"})]})]})})})]})]})}const ce={open:"red",in_progress:"yellow",resolved:"green",closed:"gray"},he={open:"Open",in_progress:"In Progress",resolved:"Resolved",closed:"Closed"};async function pe(){const t=await F.get("/hazard-observations/export/csv");return G.parse(t.data).data}function ue(t,o){if(t.length===0)return;const u={observation_date:"Tanggal",observation_time:"Waktu",facility:"Fasilitas",observer:"Observer",unsafe_action_condition:"Kondisi Tidak Aman",hazard_types:"Tipe Bahaya",potential_risks:"Potensi Risiko",potential_risk_other:"Potensi Risiko Lainnya",unsafe_reasons:"Alasan Tidak Aman",unsafe_reason_other:"Alasan Lainnya",control_measures:"Tindakan Pengendalian",control_measure_other:"Tindakan Lainnya",corrective_action:"Tindakan Korektif",status:"Status",resolved_by:"Diselesaikan Oleh",resolved_at:"Tanggal Penyelesaian",resolution_notes:"Catatan Penyelesaian"},m=Object.keys(t[0]),b=m.map(c=>u[c]||c).join(","),g=t.map(c=>m.map(i=>{const l=c[i]??"";return l.includes(",")||l.includes('"')||l.includes(`
`)?`"${l.replace(/"/g,'""')}"`:l}).join(",")),v=[b,...g].join(`
`),j=new Blob([v],{type:"text/csv;charset=utf-8;"}),x=URL.createObjectURL(j),r=document.createElement("a");r.href=x,r.setAttribute("download",o),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(x)}function me(){var S;const{user:t}=L(),{page:o,limit:u,setLimit:m,setPage:b}=M(),{filters:g,sort:v}=d.useDataTable({sortConfig:{direction:"desc",column:"observation_date"}}),[j,x]=k.useState(!1),{data:r,isLoading:c,refetch:i}=Q(),{mutate:l}=X(),y=k.useCallback(a=>{N.openConfirmModal({title:"Delete Hazard Observation",children:"Are you sure you want to delete this hazard observation?",confirmProps:{color:"red"},labels:{confirm:"Delete",cancel:"Cancel"},onConfirm:()=>{l(a),i()}})},[l,i]),s=k.useCallback(async()=>{x(!0);try{const a=await pe();if(!a||a.length===0){O.show({message:"No data to export",color:"yellow"});return}const T=`hazard_observations_${new Date().toISOString().split("T")[0]}.csv`;ue(a,T),O.show({title:"Export Berhasil",message:"File berhasil diunduh",color:"green"})}catch(a){console.error("Export failed:",a),O.show({message:"Export failed: "+a,color:"red"})}finally{x(!1)}},[]),n=(t==null?void 0:t.department)==="HSE",C=(t==null?void 0:t.role)==="MANAGER",D=k.useMemo(()=>[{accessor:"observation_date",title:"Date",sortable:!0,render:({observation_date:a,observation_time:f})=>`${new Date(a).toLocaleDateString()} ${f||""}`},{accessor:"facility_id",title:"Facility",ellipsis:!0,render:({facility_name:a,facility_id:f})=>a||f},{accessor:"unsafe_action_condition",title:"Unsafe Condition",ellipsis:!0,width:250},{accessor:"hazard_types",title:"Hazard Types",render:({hazard_types:a})=>a&&a.length>0?e.jsxs(w,{gap:4,children:[a.slice(0,2).map((f,T)=>e.jsx(P,{size:"sm",children:f},T)),a.length>2&&e.jsxs(P,{size:"sm",variant:"outline",children:["+",a.length-2]})]}):"-"},{accessor:"status",title:"Status",sortable:!0,textAlign:"center",render:({status:a})=>e.jsx(P,{color:ce[a],children:he[a]})},{accessor:"actions",title:"Actions",textAlign:"right",width:180,render:a=>e.jsx(d.Actions,{onView:()=>q(a.id),onResolve:(n||C)&&a.status!=="resolved"&&a.status!=="closed"?()=>J(a.id,i):null,onEdit:C||a.observer_id===(t==null?void 0:t.id)?()=>Y(a.id,i):null,onDelete:C?()=>y(a.id):null})}],[y,n,C,t==null?void 0:t.id,i]),H=$.alert;return e.jsxs(d.Container,{children:[e.jsx(d.Title,{icon:e.jsx(H,{size:25}),title:"Hazard Observation Cards",actions:e.jsxs(w,{gap:"xs",children:[e.jsx(U,{variant:"subtle",size:"xs",leftSection:e.jsx(ie,{size:16}),onClick:s,loading:j,children:"Export"}),e.jsx(ne,{variant:"default",size:"xs",onClick:()=>Z(i),children:"Add Observation"})]})}),e.jsx(d.Filters,{filters:g.filters,onClear:g.clear}),e.jsx(d.Content,{children:e.jsx(d.Table,{striped:!0,minHeight:240,noRecordsText:d.noRecordsText("hazard observations"),recordsPerPageLabel:d.recordsPerPageLabel("hazard observations"),paginationText:d.paginationText("hazard observations"),page:o,records:(r==null?void 0:r.data)??[],fetching:c,onPageChange:b,recordsPerPage:u,totalRecords:((S=r==null?void 0:r.meta)==null?void 0:S.total)??0,onRecordsPerPageChange:m,recordsPerPageOptions:[5,15,30],sortStatus:v.status,onSortStatusChange:v.change,columns:D,pinLastColumn:!0,highlightOnHover:!0})})]})}function Be(){const{user:t}=L(),u=[{label:"Hazard Observations",href:(t==null?void 0:t.role)==="MANAGER"?R.manager.hazardObservations:R.employee.hazardObservations}];return e.jsxs(K,{title:"Hazard Observations",children:[e.jsx(V,{title:"Hazard Observation Cards",breadcrumbs:u}),e.jsxs(p,{gap:"lg",children:[e.jsx(de,{}),e.jsx(me,{})]})]})}export{Be as default};
