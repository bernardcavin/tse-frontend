import{r as x,j as e,S as j,Q as E,e as w,a7 as Q,ai as D,T as b,m as L,B as ne,aa as ae,d as q,k as B,X as N,ap as oe,P as se,i as V,p as I}from"./index--ClWZahu.js";import{P as ie}from"./page-CknD4dKm.js";import{P as re}from"./page-header-BWjuV_E8.js";import{D as d,A as ce}from"./index-DqV8S-Pt.js";import{a as le,A as $,b as de,c as G,d as ue,e as me,u as he}from"./attendance-Ds-IZYDR.js";import{u as pe,d as xe,l as ge,b as fe,e as je,M as H,T as J,a as U,L as be,Q as Ce}from"./index-Cc0-q_aR.js";import{F as k,G as h}from"./form-section-C5VgLGpa.js";import{a as Se,g as ye}from"./facilities-BJtlO5v9.js";import{a as Ae,T as Le,N as _}from"./text-area-CTQii59r.js";import{T as O}from"./text-input-BLEms8uL.js";import{h as W,F as K}from"./form-CN9S1QwI.js";import{u as Z,z as X}from"./use-form-L8LbUW_M.js";import{I as ve,a as Pe}from"./IconPlus-BmH8SaqF.js";import{S as Re}from"./Select-UMZ64bLE.js";import"./Title-Ci985OzB.js";import"./Anchor-DIBe1ZWb.js";import"./index-Bn0zxFJ3.js";import"./facility-CsGiLvNK.js";import"./DatePickerInput-BeLOAKO0.js";import"./createReactComponent-BM7tdotx.js";function ke(n,t,o){t.center!==o.center&&n.setLatLng(t.center),t.radius!=null&&t.radius!==o.radius&&n.setRadius(t.radius)}function Fe(){return pe().map}function we(n){const t=Fe();return x.useEffect(function(){return t.on(n),function(){t.off(n)}},[t,n]),t}const ze=xe(function({center:t,children:o,...a},c){const l=new ge.Circle(t,a);return fe(l,je(c,{overlayContainer:l}))},ke);function Me({onLocationChange:n,initialLat:t,initialLon:o}){const[a,c]=x.useState([t||-6.2088,o||106.8456]),l=()=>(we({click(s){const{lat:p,lng:m}=s.latlng;c([p,m]),n(p,m)}}),null);return x.useEffect(()=>{const s=typeof t=="number"&&t>=-90&&t<=90,p=typeof o=="number"&&o>=-180&&o<=180;s&&p&&c([t,o])},[t,o]),e.jsxs(H,{center:a,zoom:13,style:{height:400,width:"100%",borderRadius:8},scrollWheelZoom:!0,children:[e.jsx(J,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),e.jsx(U,{position:a}),e.jsx(l,{})]})}function Y({form:n}){const[t,o]=x.useState(null),{data:a,isLoading:c}=D({queryKey:["facilityOptions"],queryFn:Se}),{data:l,isLoading:s}=D({queryKey:["facilityCoordinates",t],queryFn:()=>ye(t),enabled:!!t});x.useEffect(()=>{if(l&&t){const m=a==null?void 0:a.find(g=>g.value===t);m&&n.setFieldValue("location_name",m.label),n.setFieldValue("latitude",l.latitude),n.setFieldValue("longitude",l.longitude)}},[l,t,a]);const p=(m,g)=>{n.setFieldValue("latitude",m),n.setFieldValue("longitude",g)};return e.jsxs(j,{gap:"md",children:[e.jsx(k,{title:"Import from Facility (Optional)",children:e.jsx(h,{children:e.jsxs(h.Col,{span:12,children:[e.jsx(Re,{label:"Select Facility",placeholder:"Choose a facility to auto-fill location details",data:a||[],value:t,onChange:m=>o(m),searchable:!0,clearable:!0,description:"Selecting a facility will auto-populate name and coordinates",disabled:c,comboboxProps:{zIndex:2e3}}),s&&e.jsx(b,{size:"sm",c:"dimmed",children:"Loading facility coordinates..."})]})})}),e.jsx(k,{title:"Basic Information",children:e.jsxs(h,{children:[e.jsx(h.Col,{span:{base:12,sm:6},children:e.jsx(O,{name:"location_name",label:"Location Name",placeholder:"e.g. Jakarta Office, Rig Site Alpha",required:!0,description:"Name of the attendance location"})}),e.jsx(h.Col,{span:{base:12,sm:6},children:e.jsx(Ae,{name:"is_active",label:"Active",description:"Location is active for check-in"})}),e.jsx(h.Col,{span:12,children:e.jsx(Le,{name:"description",label:"Description",placeholder:"Additional details about this location",autosize:!0,minRows:2})}),e.jsx(h.Col,{span:12,children:e.jsx(O,{name:"address",label:"Address",placeholder:"e.g. Jl. Sudirman No. 10, Jakarta",description:"Physical address of the location"})})]})}),e.jsx(k,{title:"Location & Geofence",children:e.jsxs(j,{gap:"md",children:[e.jsx(b,{size:"sm",c:"dimmed",children:"Click on the map to set the location coordinates. The geofence radius determines how close employees must be to check in."}),e.jsx(Me,{onLocationChange:p,initialLat:n.values.latitude,initialLon:n.values.longitude}),e.jsxs(h,{children:[e.jsx(h.Col,{span:{base:12,sm:4},children:e.jsx(_,{required:!0,name:"latitude",label:"Latitude",placeholder:"e.g. -6.2088",description:"Click map to update",decimalScale:6})}),e.jsx(h.Col,{span:{base:12,sm:4},children:e.jsx(_,{required:!0,name:"longitude",label:"Longitude",placeholder:"e.g. 106.8456",description:"Click map to update",decimalScale:6})}),e.jsx(h.Col,{span:{base:12,sm:4},children:e.jsx(_,{required:!0,name:"radius_meters",label:"Geofence Radius (meters)",placeholder:"e.g. 100",description:"Check-in radius",min:1,max:1e4})})]})]})})]})}function Te({onSubmit:n}){const{mutate:t,isPending:o}=le(),a=Z({mode:"controlled",validate:X($),initialValues:{location_name:"",description:"",address:"",latitude:-6.2088,longitude:106.8456,radius_meters:100,is_active:!0}}),c=a.onSubmit(l=>{t({variables:l},{onError:s=>W(a,s),onSuccess:()=>{n()}})});return e.jsx(K,{form:a,onSubmit:c,children:e.jsxs(j,{children:[e.jsx(Y,{form:a}),e.jsx(E,{justify:"flex-end",children:e.jsx(w,{type:"submit",loading:o,mt:"md",leftSection:e.jsx(ve,{size:16,stroke:5}),children:"Add Location"})})]})})}function _e({onSubmit:n,id:t}){const{mutate:o,isPending:a}=de({route:{id:t}}),{data:c,isLoading:l}=G({route:{id:t}}),s=Z({mode:"controlled",validate:X($)});x.useEffect(()=>{c&&s.setValues(c)},[c]);const p=s.onSubmit(m=>{o({variables:m},{onError:g=>W(s,g),onSuccess:()=>{n()}})});return l?e.jsx(Q,{color:"blue",size:"xl"}):e.jsx(K,{form:s,onSubmit:p,children:e.jsxs(j,{children:[e.jsx(Y,{form:s}),e.jsx(E,{justify:"flex-end",children:e.jsx(w,{type:"submit",loading:a,mt:"md",leftSection:e.jsx(Pe,{size:16,stroke:2}),children:"Save Changes"})})]})})}function Ee({id:n}){const{data:t,isLoading:o}=G({route:{id:n}});if(o)return e.jsx(E,{justify:"center",py:"xl",children:e.jsx(Q,{size:"lg"})});if(!t)return e.jsx(b,{c:"dimmed",ta:"center",py:"xl",children:"No location data found."});const a=t,c=a.latitude!==null&&a.longitude!==null;return e.jsxs(j,{gap:"lg",children:[e.jsx(k,{title:"Basic Information",children:e.jsxs(h,{children:[e.jsxs(h.Col,{span:{base:12,sm:6},children:[e.jsx(R,{label:"Location Name",value:a.location_name}),e.jsx(R,{label:"Description",value:a.description}),e.jsx(R,{label:"Address",value:a.address})]}),e.jsxs(h.Col,{span:{base:12,sm:6},children:[e.jsx(R,{label:"Status",value:a.is_active?"✅ Active":"❌ Inactive"}),e.jsx(R,{label:"Radius",value:`${a.radius_meters}m`})]})]})}),c&&e.jsxs(k,{title:"Location Map",children:[e.jsx(ne,{style:{height:400,borderRadius:12,overflow:"hidden"},children:e.jsxs(H,{center:[a.latitude,a.longitude],zoom:15,style:{height:"100%",width:"100%"},scrollWheelZoom:!1,children:[e.jsx(J,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),e.jsx(ze,{center:[a.latitude,a.longitude],radius:a.radius_meters,pathOptions:{color:"blue",fillColor:"blue",fillOpacity:.2}}),e.jsx(U,{position:[a.latitude,a.longitude],icon:be.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",iconSize:[40,40]})})]})}),e.jsxs(b,{size:"sm",c:"dimmed",ta:"center",mt:"xs",children:["Blue circle shows the geofence radius (",a.radius_meters,"m)"]})]})]})}function R({label:n,value:t}){return e.jsxs(j,{gap:2,mb:"sm",children:[e.jsx(b,{c:"dimmed",fz:"sm",children:n}),e.jsx(b,{fw:500,style:{wordBreak:"break-word"},children:t??"-"}),e.jsx(ae,{my:4})]})}function De(n){L.open({title:"Add New Attendance Location",children:e.jsx(Te,{onSubmit:()=>{n(),L.closeAll()}}),size:"75rem",zIndex:2e3,withCloseButton:!1})}function Ie(n,t){L.open({title:"Edit Attendance Location",children:e.jsx(_e,{id:n,onSubmit:()=>{t(),L.closeAll()}}),size:"75rem",zIndex:2e3,withCloseButton:!1})}function Oe(n){L.open({title:"View Attendance Location",children:e.jsx(Ee,{id:n}),size:"75rem",zIndex:2e3,withCloseButton:!1})}function Qe(){const{user:n}=q(),{page:t,limit:o,setLimit:a,setPage:c}=B(),[l,s]=x.useState(!1),[p,m]=x.useState(null),[g,z]=x.useState(""),y=(n==null?void 0:n.role)==="MANAGER",{filters:F,sort:r}=d.useDataTable({sortConfig:{direction:"asc",column:"location_name"}}),{data:u,isLoading:v,refetch:C}=ue({query:{page:t,limit:o,sort:r.query}}),{mutate:S}=me(),A=x.useCallback(i=>{L.openConfirmModal({title:"Delete Attendance Location",children:"Are you sure you want to delete this attendance location?",confirmProps:{color:"red"},labels:{confirm:"Delete",cancel:"Cancel"},onConfirm:()=>{S({route:{id:i}}),C()}})},[S,C]),P=(i,f)=>{m(i),z(f),s(!0)},M=()=>{const i=document.getElementById("qr-code-canvas");if(i){const f=i.toDataURL("image/png"),T=document.createElement("a");T.download=`${g.replace(/\s+/g,"_")}_QR.png`,T.href=f,T.click()}},ee=x.useMemo(()=>[{accessor:"location_name",title:"Location Name",sortable:!0},{accessor:"address",title:"Address",sortable:!0},{accessor:"latitude",title:"Coordinates",render:({latitude:i,longitude:f})=>`${i==null?void 0:i.toFixed(6)}, ${f==null?void 0:f.toFixed(6)}`},{accessor:"radius_meters",title:"Radius",render:({radius_meters:i})=>`${i}m`},{accessor:"is_active",title:"Status",textAlign:"center",render:({is_active:i})=>e.jsx(N,{color:i?"green":"gray",variant:"light",children:i?"Active":"Inactive"})},{accessor:"qr_code_data",title:"QR Code",textAlign:"center",render:({qr_code_data:i,location_name:f})=>i?e.jsx(w,{size:"xs",variant:"light",onClick:()=>P(i,f),children:"View QR"}):e.jsx(b,{c:"dimmed",size:"sm",children:"No QR"})},{accessor:"actions",title:"Actions",textAlign:"right",width:130,render:i=>e.jsx(d.Actions,{onView:()=>Oe(i.id),onEdit:y?()=>Ie(i.id,C):void 0,onDelete:y?()=>A(i.id):void 0})}],[A,y]),te=V.building;return e.jsxs(e.Fragment,{children:[e.jsxs(d.Container,{children:[e.jsx(d.Title,{icon:e.jsx(te,{size:25}),title:"Attendance Locations",actions:y?e.jsx(ce,{variant:"default",size:"xs",onClick:()=>De(C),children:"Add Location"}):void 0}),e.jsx(d.Filters,{filters:F.filters,onClear:F.clear}),e.jsx(d.Content,{children:e.jsx(d.Table,{striped:!0,minHeight:240,noRecordsText:d.noRecordsText("attendance locations"),recordsPerPageLabel:d.recordsPerPageLabel("attendance locations"),paginationText:d.paginationText("attendance locations"),page:t,records:(u==null?void 0:u.data)??[],fetching:v,onPageChange:c,recordsPerPage:o,totalRecords:(u==null?void 0:u.meta.total)??0,onRecordsPerPageChange:a,recordsPerPageOptions:[5,15,30],sortStatus:r.status,onSortStatusChange:r.change,columns:ee,pinLastColumn:!0,highlightOnHover:!0})})]}),e.jsx(oe,{opened:l,onClose:()=>s(!1),title:`QR Code - ${g}`,centered:!0,children:e.jsxs(j,{align:"center",children:[p&&e.jsx(se,{shadow:"xs",p:"md",withBorder:!0,children:e.jsx(Ce,{id:"qr-code-canvas",value:p,size:300})}),e.jsx(b,{size:"sm",c:"dimmed",ta:"center",children:"Employees can scan this QR code to check in at this location"}),e.jsx(w,{fullWidth:!0,onClick:M,children:"Download QR Code"})]})})]})}function qe(){const{page:n,limit:t,setLimit:o,setPage:a}=B(),{filters:c,sort:l}=d.useDataTable({sortConfig:{direction:"desc",column:"check_in_time"}}),{data:s,isLoading:p,refetch:m}=he({query:{page:n,limit:t,sort:l.query}}),g=r=>{const u=new Date(r),v=u.getFullYear(),C=String(u.getMonth()+1).padStart(2,"0"),S=String(u.getDate()).padStart(2,"0"),A=String(u.getHours()).padStart(2,"0"),P=String(u.getMinutes()).padStart(2,"0"),M=String(u.getSeconds()).padStart(2,"0");return`${v}-${C}-${S} ${A}:${P}:${M}`},z=(r,u)=>{if(!u)return"In progress";const v=new Date(r),S=new Date(u).getTime()-v.getTime(),A=Math.floor(S/(1e3*60*60)),P=Math.floor(S%(1e3*60*60)/(1e3*60));return`${A}h ${P}m`},y=x.useMemo(()=>[{accessor:"employee_name",title:"Employee",render:({employee_name:r})=>r??"-"},{accessor:"location_name",title:"Location",render:({location_name:r})=>r??"-"},{accessor:"check_in_time",title:"Check In",sortable:!0,render:({check_in_time:r})=>g(r)},{accessor:"check_out_time",title:"Check Out",sortable:!0,render:({check_out_time:r})=>r?g(r):"-"},{accessor:"duration",title:"Duration",render:({check_in_time:r,check_out_time:u})=>z(r,u??null)},{accessor:"status",title:"Status",textAlign:"center",render:({status:r})=>e.jsx(N,{color:r==="checked_in"?"green":"gray",variant:"light",children:r==="checked_in"?"Checked In":"Checked Out"})}],[]),F=V.clock;return e.jsxs(d.Container,{children:[e.jsx(d.Title,{icon:e.jsx(F,{size:25}),title:"Attendance Records"}),e.jsx(d.Filters,{filters:c.filters,onClear:c.clear}),e.jsx(d.Content,{children:e.jsx(d.Table,{striped:!0,minHeight:240,noRecordsText:d.noRecordsText("attendance records"),recordsPerPageLabel:d.recordsPerPageLabel("attendance records"),paginationText:d.paginationText("attendance records"),page:n,records:(s==null?void 0:s.data)??[],fetching:p,onPageChange:a,recordsPerPage:t,totalRecords:(s==null?void 0:s.meta.total)??0,onRecordsPerPageChange:o,recordsPerPageOptions:[5,15,30],sortStatus:l.status,onSortStatusChange:l.change,columns:y,highlightOnHover:!0})})]})}function rt(){const{user:n}=q(),o=[{label:"Attendance",href:(n==null?void 0:n.role)==="MANAGER"?I.manager.attendance:I.employee.attendance},{label:"Management"}];return e.jsxs(ie,{title:"Attendance Management",children:[e.jsx(re,{title:"Attendance Management",breadcrumbs:o}),e.jsxs(j,{gap:"lg",children:[e.jsx(Qe,{}),e.jsx(qe,{})]})]})}export{rt as default};
