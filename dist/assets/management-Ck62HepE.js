import{r as x,j as e,S as f,Q as M,e as R,a7 as I,ai as _,T as j,m as L,B as Y,aa as ee,k as O,X as Q,ap as te,P as ne,i as q,d as ae,p as E}from"./index-CXSFYyxW.js";import{P as se}from"./page-Ce6TGwLS.js";import{P as oe}from"./page-header-BVWNkGag.js";import{D as d,A as ie}from"./index-D90JWwRy.js";import{a as re,A as B,b as ce,c as V,d as le,e as de,u as ue}from"./attendance-X8bTN14-.js";import{u as me,f as he,l as xe,e as pe,g as ge,c as fe,b as je,N as T,M as N,T as G,a as $,L as be,Q as Ce}from"./text-area-Ba8RbfB-.js";import{F as P,S as Le}from"./form-section-D8uUwEyA.js";import{a as ye,g as Ae}from"./facilities-5-RoYIHp.js";import{T as D}from"./text-input-BiFELoxz.js";import{h as H,F as J}from"./form-CxrjEW7m.js";import{u as U,z as W}from"./use-form-BfKcSDAq.js";import{I as Se,a as Pe}from"./facility-CQkLYzbH.js";import{G as m}from"./DatePickerInput-3D4XORCr.js";import"./Title-BNjJXA_3.js";import"./Anchor-DWr_l9ng.js";import"./index-D9tSIssD.js";import"./createReactComponent-FEKyEq6n.js";function ve(n,t,s){t.center!==s.center&&n.setLatLng(t.center),t.radius!=null&&t.radius!==s.radius&&n.setRadius(t.radius)}function Re(){return me().map}function ke(n){const t=Re();return x.useEffect(function(){return t.on(n),function(){t.off(n)}},[t,n]),t}const we=he(function({center:t,children:s,...a},l){const c=new xe.Circle(t,a);return pe(c,ge(l,{overlayContainer:c}))},ve);function ze({onLocationChange:n,initialLat:t,initialLon:s}){const[a,l]=x.useState([t||-6.2088,s||106.8456]),c=()=>(ke({click(o){const{lat:h,lng:u}=o.latlng;l([h,u]),n(h,u)}}),null);return x.useEffect(()=>{const o=typeof t=="number"&&t>=-90&&t<=90,h=typeof s=="number"&&s>=-180&&s<=180;o&&h&&l([t,s])},[t,s]),e.jsxs(N,{center:a,zoom:13,style:{height:400,width:"100%",borderRadius:8},scrollWheelZoom:!0,children:[e.jsx(G,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),e.jsx($,{position:a}),e.jsx(c,{})]})}function K({form:n}){const[t,s]=x.useState(null),{data:a,isLoading:l}=_({queryKey:["facilityOptions"],queryFn:ye}),{data:c,isLoading:o}=_({queryKey:["facilityCoordinates",t],queryFn:()=>Ae(t),enabled:!!t});x.useEffect(()=>{if(c&&t){const u=a==null?void 0:a.find(p=>p.value===t);u&&n.setFieldValue("location_name",u.label),n.setFieldValue("latitude",c.latitude),n.setFieldValue("longitude",c.longitude)}},[c,t,a]);const h=(u,p)=>{n.setFieldValue("latitude",u),n.setFieldValue("longitude",p)};return e.jsxs(f,{gap:"md",children:[e.jsx(P,{title:"Import from Facility (Optional)",children:e.jsx(m,{children:e.jsxs(m.Col,{span:12,children:[e.jsx(Le,{label:"Select Facility",placeholder:"Choose a facility to auto-fill location details",data:a||[],value:t,onChange:u=>s(u),searchable:!0,clearable:!0,description:"Selecting a facility will auto-populate name and coordinates",disabled:l,comboboxProps:{zIndex:2e3}}),o&&e.jsx(j,{size:"sm",c:"dimmed",children:"Loading facility coordinates..."})]})})}),e.jsx(P,{title:"Basic Information",children:e.jsxs(m,{children:[e.jsx(m.Col,{span:{base:12,sm:6},children:e.jsx(D,{name:"location_name",label:"Location Name",placeholder:"e.g. Jakarta Office, Rig Site Alpha",required:!0,description:"Name of the attendance location"})}),e.jsx(m.Col,{span:{base:12,sm:6},children:e.jsx(fe,{name:"is_active",label:"Active",description:"Location is active for check-in"})}),e.jsx(m.Col,{span:12,children:e.jsx(je,{name:"description",label:"Description",placeholder:"Additional details about this location",autosize:!0,minRows:2})}),e.jsx(m.Col,{span:12,children:e.jsx(D,{name:"address",label:"Address",placeholder:"e.g. Jl. Sudirman No. 10, Jakarta",description:"Physical address of the location"})})]})}),e.jsx(P,{title:"Location & Geofence",children:e.jsxs(f,{gap:"md",children:[e.jsx(j,{size:"sm",c:"dimmed",children:"Click on the map to set the location coordinates. The geofence radius determines how close employees must be to check in."}),e.jsx(ze,{onLocationChange:h,initialLat:n.values.latitude,initialLon:n.values.longitude}),e.jsxs(m,{children:[e.jsx(m.Col,{span:{base:12,sm:4},children:e.jsx(T,{required:!0,name:"latitude",label:"Latitude",placeholder:"e.g. -6.2088",description:"Click map to update",decimalScale:6})}),e.jsx(m.Col,{span:{base:12,sm:4},children:e.jsx(T,{required:!0,name:"longitude",label:"Longitude",placeholder:"e.g. 106.8456",description:"Click map to update",decimalScale:6})}),e.jsx(m.Col,{span:{base:12,sm:4},children:e.jsx(T,{required:!0,name:"radius_meters",label:"Geofence Radius (meters)",placeholder:"e.g. 100",description:"Check-in radius",min:1,max:1e4})})]})]})})]})}function Fe({onSubmit:n}){const{mutate:t,isPending:s}=re(),a=U({mode:"controlled",validate:W(B),initialValues:{location_name:"",description:"",address:"",latitude:-6.2088,longitude:106.8456,radius_meters:100,is_active:!0}}),l=a.onSubmit(c=>{t({variables:c},{onError:o=>H(a,o),onSuccess:()=>{n()}})});return e.jsx(J,{form:a,onSubmit:l,children:e.jsxs(f,{children:[e.jsx(K,{form:a}),e.jsx(M,{justify:"flex-end",children:e.jsx(R,{type:"submit",loading:s,mt:"md",leftSection:e.jsx(Se,{size:16,stroke:5}),children:"Add Location"})})]})})}function Te({onSubmit:n,id:t}){const{mutate:s,isPending:a}=ce({route:{id:t}}),{data:l,isLoading:c}=V({route:{id:t}}),o=U({mode:"controlled",validate:W(B)});x.useEffect(()=>{l&&o.setValues(l)},[l]);const h=o.onSubmit(u=>{s({variables:u},{onError:p=>H(o,p),onSuccess:()=>{n()}})});return c?e.jsx(I,{color:"blue",size:"xl"}):e.jsx(J,{form:o,onSubmit:h,children:e.jsxs(f,{children:[e.jsx(K,{form:o}),e.jsx(M,{justify:"flex-end",children:e.jsx(R,{type:"submit",loading:a,mt:"md",leftSection:e.jsx(Pe,{size:16,stroke:2}),children:"Save Changes"})})]})})}function Me({id:n}){const{data:t,isLoading:s}=V({route:{id:n}});if(s)return e.jsx(M,{justify:"center",py:"xl",children:e.jsx(I,{size:"lg"})});if(!t)return e.jsx(j,{c:"dimmed",ta:"center",py:"xl",children:"No location data found."});const a=t,l=a.latitude!==null&&a.longitude!==null;return e.jsxs(f,{gap:"lg",children:[e.jsx(P,{title:"Basic Information",children:e.jsxs(m,{children:[e.jsxs(m.Col,{span:{base:12,sm:6},children:[e.jsx(S,{label:"Location Name",value:a.location_name}),e.jsx(S,{label:"Description",value:a.description}),e.jsx(S,{label:"Address",value:a.address})]}),e.jsxs(m.Col,{span:{base:12,sm:6},children:[e.jsx(S,{label:"Status",value:a.is_active?"✅ Active":"❌ Inactive"}),e.jsx(S,{label:"Radius",value:`${a.radius_meters}m`})]})]})}),l&&e.jsxs(P,{title:"Location Map",children:[e.jsx(Y,{style:{height:400,borderRadius:12,overflow:"hidden"},children:e.jsxs(N,{center:[a.latitude,a.longitude],zoom:15,style:{height:"100%",width:"100%"},scrollWheelZoom:!1,children:[e.jsx(G,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),e.jsx(we,{center:[a.latitude,a.longitude],radius:a.radius_meters,pathOptions:{color:"blue",fillColor:"blue",fillOpacity:.2}}),e.jsx($,{position:[a.latitude,a.longitude],icon:be.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",iconSize:[40,40]})})]})}),e.jsxs(j,{size:"sm",c:"dimmed",ta:"center",mt:"xs",children:["Blue circle shows the geofence radius (",a.radius_meters,"m)"]})]})]})}function S({label:n,value:t}){return e.jsxs(f,{gap:2,mb:"sm",children:[e.jsx(j,{c:"dimmed",fz:"sm",children:n}),e.jsx(j,{fw:500,style:{wordBreak:"break-word"},children:t??"-"}),e.jsx(ee,{my:4})]})}function _e(n){L.open({title:"Add New Attendance Location",children:e.jsx(Fe,{onSubmit:()=>{n(),L.closeAll()}}),size:"75rem",zIndex:2e3,withCloseButton:!1})}function Ee(n,t){L.open({title:"Edit Attendance Location",children:e.jsx(Te,{id:n,onSubmit:()=>{t(),L.closeAll()}}),size:"75rem",zIndex:2e3,withCloseButton:!1})}function De(n){L.open({title:"View Attendance Location",children:e.jsx(Me,{id:n}),size:"75rem",zIndex:2e3,withCloseButton:!1})}function Ie(){const{page:n,limit:t,setLimit:s,setPage:a}=O(),[l,c]=x.useState(!1),[o,h]=x.useState(null),[u,p]=x.useState(""),{filters:v,sort:y}=d.useDataTable({sortConfig:{direction:"asc",column:"location_name"}}),{data:i,isLoading:b,refetch:C}=le({query:{page:n,limit:t,sort:y.query}}),{mutate:k}=de(),A=x.useCallback(r=>{L.openConfirmModal({title:"Delete Attendance Location",children:"Are you sure you want to delete this attendance location?",confirmProps:{color:"red"},labels:{confirm:"Delete",cancel:"Cancel"},onConfirm:()=>{k({route:{id:r}}),C()}})},[k,C]),w=(r,g)=>{h(r),p(g),c(!0)},z=()=>{const r=document.getElementById("qr-code-canvas");if(r){const g=r.toDataURL("image/png"),F=document.createElement("a");F.download=`${u.replace(/\s+/g,"_")}_QR.png`,F.href=g,F.click()}},Z=x.useMemo(()=>[{accessor:"location_name",title:"Location Name",sortable:!0},{accessor:"address",title:"Address",sortable:!0},{accessor:"latitude",title:"Coordinates",render:({latitude:r,longitude:g})=>`${r==null?void 0:r.toFixed(6)}, ${g==null?void 0:g.toFixed(6)}`},{accessor:"radius_meters",title:"Radius",render:({radius_meters:r})=>`${r}m`},{accessor:"is_active",title:"Status",textAlign:"center",render:({is_active:r})=>e.jsx(Q,{color:r?"green":"gray",variant:"light",children:r?"Active":"Inactive"})},{accessor:"qr_code_data",title:"QR Code",textAlign:"center",render:({qr_code_data:r,location_name:g})=>r?e.jsx(R,{size:"xs",variant:"light",onClick:()=>w(r,g),children:"View QR"}):e.jsx(j,{c:"dimmed",size:"sm",children:"No QR"})},{accessor:"actions",title:"Actions",textAlign:"right",width:130,render:r=>e.jsx(d.Actions,{onView:()=>De(r.id),onEdit:()=>Ee(r.id,C),onDelete:()=>A(r.id)})}],[A]),X=q.building;return e.jsxs(e.Fragment,{children:[e.jsxs(d.Container,{children:[e.jsx(d.Title,{icon:e.jsx(X,{size:25}),title:"Attendance Locations",actions:e.jsx(ie,{variant:"default",size:"xs",onClick:()=>_e(C),children:"Add Location"})}),e.jsx(d.Filters,{filters:v.filters,onClear:v.clear}),e.jsx(d.Content,{children:e.jsx(d.Table,{striped:!0,minHeight:240,noRecordsText:d.noRecordsText("attendance locations"),recordsPerPageLabel:d.recordsPerPageLabel("attendance locations"),paginationText:d.paginationText("attendance locations"),page:n,records:(i==null?void 0:i.data)??[],fetching:b,onPageChange:a,recordsPerPage:t,totalRecords:(i==null?void 0:i.meta.total)??0,onRecordsPerPageChange:s,recordsPerPageOptions:[5,15,30],sortStatus:y.status,onSortStatusChange:y.change,columns:Z,pinLastColumn:!0,highlightOnHover:!0})})]}),e.jsx(te,{opened:l,onClose:()=>c(!1),title:`QR Code - ${u}`,centered:!0,children:e.jsxs(f,{align:"center",children:[o&&e.jsx(ne,{shadow:"xs",p:"md",withBorder:!0,children:e.jsx(Ce,{id:"qr-code-canvas",value:o,size:300})}),e.jsx(j,{size:"sm",c:"dimmed",ta:"center",children:"Employees can scan this QR code to check in at this location"}),e.jsx(R,{fullWidth:!0,onClick:z,children:"Download QR Code"})]})})]})}function Oe(){const{page:n,limit:t,setLimit:s,setPage:a}=O(),{filters:l,sort:c}=d.useDataTable({sortConfig:{direction:"desc",column:"check_in_time"}}),{data:o,isLoading:h,refetch:u}=ue({query:{page:n,limit:t,sort:c.query}}),p=(i,b)=>{if(!b)return"In progress";const C=new Date(i),A=new Date(b).getTime()-C.getTime(),w=Math.floor(A/(1e3*60*60)),z=Math.floor(A%(1e3*60*60)/(1e3*60));return`${w}h ${z}m`},v=x.useMemo(()=>[{accessor:"employee_name",title:"Employee",render:({employee_name:i})=>i??"-"},{accessor:"location_name",title:"Location",render:({location_name:i})=>i??"-"},{accessor:"check_in_time",title:"Check In",sortable:!0,render:({check_in_time:i})=>new Date(i).toLocaleString()},{accessor:"check_out_time",title:"Check Out",sortable:!0,render:({check_out_time:i})=>i?new Date(i).toLocaleString():"-"},{accessor:"duration",title:"Duration",render:({check_in_time:i,check_out_time:b})=>p(i,b??null)},{accessor:"status",title:"Status",textAlign:"center",render:({status:i})=>e.jsx(Q,{color:i==="checked_in"?"green":"gray",variant:"light",children:i==="checked_in"?"Checked In":"Checked Out"})}],[]),y=q.clock;return e.jsxs(d.Container,{children:[e.jsx(d.Title,{icon:e.jsx(y,{size:25}),title:"Attendance Records"}),e.jsx(d.Filters,{filters:l.filters,onClear:l.clear}),e.jsx(d.Content,{children:e.jsx(d.Table,{striped:!0,minHeight:240,noRecordsText:d.noRecordsText("attendance records"),recordsPerPageLabel:d.recordsPerPageLabel("attendance records"),paginationText:d.paginationText("attendance records"),page:n,records:(o==null?void 0:o.data)??[],fetching:h,onPageChange:a,recordsPerPage:t,totalRecords:(o==null?void 0:o.meta.total)??0,onRecordsPerPageChange:s,recordsPerPageOptions:[5,15,30],sortStatus:c.status,onSortStatusChange:c.change,columns:v,highlightOnHover:!0})})]})}function nt(){const{user:n}=ae(),s=[{label:"Attendance",href:(n==null?void 0:n.role)==="MANAGER"?E.manager.attendance:E.employee.attendance},{label:"Management"}];return e.jsxs(se,{title:"Attendance Management",children:[e.jsx(oe,{title:"Attendance Management",breadcrumbs:s}),e.jsxs(f,{gap:"lg",children:[e.jsx(Ie,{}),e.jsx(Oe,{})]})]})}export{nt as default};
